<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Standalone A11y Scanner</title>
    <style>
        body { font-family: system-ui, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; line-height: 1.5; }
        #warning { background: #ffebee; border: 1px solid #ffcdd2; padding: 10px; color: #b71c1c; font-weight: bold; margin-bottom: 20px; }
        .controls { background: #f5f5f5; padding: 15px; border-radius: 4px; margin-bottom: 20px; }
        .form-group { margin-bottom: 10px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        input[type="text"], input[type="number"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background: #0056b3; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #status { margin: 20px 0; font-weight: bold; }
        #results { margin-top: 30px; }
        .error { color: red; }
        .success { color: green; }
        
        /* Report Styles */
        .violation { border: 1px solid #ddd; margin-bottom: 10px; padding: 10px; border-radius: 4px; }
        .violation h4 { margin: 0 0 5px 0; color: #d32f2f; }
        pre { background: #333; color: white; padding: 5px; overflow-x: auto; }
        
        #gate-screen { position: fixed; top:0; left:0; width:100%; height:100%; background:white; display:flex; justify-content:center; align-items:center; z-index: 1000; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="gate-screen">
    <div style="text-align:center;">
        <h2>Access Denied</h2>
        <p>Please provide a valid token parameter.</p>
    </div>
</div>

<div id="app" class="hidden">
    <div id="warning">
        <h2>⚠️ SECURITY WARNING</h2>
        <p><strong>Authenticated Context Risk:</strong> This scanner runs with <em>your</em> browser cookies. If you are logged into a CMS/Admin panel, this scanner can access protected pages.</p>
        <p><strong>Server Load Risk:</strong> Scanning many pages rapidly can slow down your server. A minimum delay of 1000ms is enforced.</p>
        <p><strong>Do not deploy this to Production without password protection (Basic Auth/VPN).</strong></p>
    </div>

    <h1>Standalone Accessibility Scanner</h1>
    
    <div class="controls">
        <div class="form-group">
            <label>Scan Source</label>
            <select id="sourceType">
                <option value="sitemap">Sitemap (sitemap.xml)</option>
                <option value="custom">Custom List (below)</option>
            </select>
        </div>
        
        <div class="form-group" id="sitemapInputGroup">
            <label>Sitemap Path</label>
            <input type="text" id="sitemapPath" value="/sitemap.xml">
        </div>

        <div class="form-group hidden" id="customListGroup">
             <label>URLs (one per line)</label>
             <textarea id="customUrlList" style="width:100%; height:100px; padding:8px;"></textarea>
        </div>

        <div class="form-group">
            <label>Path Prefix Filter (optional)</label>
            <input type="text" id="pathPrefix" placeholder="/blog">
        </div>

        <div class="form-group">
            <label>Exclude Substring (optional)</label>
            <input type="text" id="excludeStr" placeholder="admin, login">
        </div>

        <div class="form-group">
            <label>Max Pages</label>
            <input type="number" id="maxPages" value="50">
        </div>

        <div class="form-group">
            <label>Delay (ms) - Minimum 1000ms</label>
            <input type="number" id="delayMs" value="1000" min="1000">
        </div>

        <div class="form-group">
            <label>Axe Script Path</label>
            <input type="text" id="axePath" value="assets/axe.min.js">
        </div>

        <button id="startBtn">Start Scan</button>
        <button id="exportBtn" disabled>Export JSON</button>
    </div>

    <div id="status">Ready</div>
    <div id="progress"></div>

    <div id="results"></div>
</div>

<iframe id="scanFrame" style="width:1px; height:1px; visibility:hidden;"></iframe>

<script>
    // SECURITY CONFIG
    const VALID_TOKEN = "A11Y-SECRET"; // Change this or use env replacement

    // Init Access Control
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');
    
    if (token === VALID_TOKEN) {
        document.getElementById('gate-screen').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
    }

    // UI Logic
    const sourceType = document.getElementById('sourceType');
    sourceType.addEventListener('change', () => {
        if(sourceType.value === 'custom') {
            document.getElementById('customListGroup').classList.remove('hidden');
            document.getElementById('sitemapInputGroup').classList.add('hidden');
        } else {
             document.getElementById('customListGroup').classList.add('hidden');
             document.getElementById('sitemapInputGroup').classList.remove('hidden');
        }
    });

    const startBtn = document.getElementById('startBtn');
    const exportBtn = document.getElementById('exportBtn');
    const statusEl = document.getElementById('status');
    const resultsEl = document.getElementById('results');
    const iframe = document.getElementById('scanFrame');

    let allResults = {};
    let runMetadata = {};

    startBtn.addEventListener('click', async () => {
        startBtn.disabled = true;
        exportBtn.disabled = true;
        resultsEl.innerHTML = '';
        allResults = {};
        
        try {
            await runScan();
        } catch (e) {
            statusEl.innerHTML = `<span class="error">Error: ${e.message}</span>`;
            console.error(e);
        } finally {
            startBtn.disabled = false;
        }
    });

    exportBtn.addEventListener('click', () => {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(runMetadata, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "scan-results.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    });

    async function runScan() {
        const config = {
            maxPages: parseInt(document.getElementById('maxPages').value, 10),
            delay: parseInt(document.getElementById('delayMs').value, 10),
            prefix: document.getElementById('pathPrefix').value,
            exclude: document.getElementById('excludeStr').value,
            axePath: document.getElementById('axePath').value
        };

        statusEl.innerText = "Fetching URLs...";
        
        let urls = [];
        if (sourceType.value === 'sitemap') {
            urls = await fetchSitemap(document.getElementById('sitemapPath').value);
        } else {
            urls = document.getElementById('customUrlList').value.split('\n').map(u=>u.trim()).filter(u=>u);
        }

        // Filtering
        if (config.prefix) {
            urls = urls.filter(u => new URL(u, window.location.origin).pathname.startsWith(config.prefix));
        }
        if (config.exclude) {
            const excludes = config.exclude.split(',').map(s=>s.trim());
            urls = urls.filter(u => !excludes.some(ex => u.includes(ex)));
        }

        // Slice
        urls = urls.slice(0, config.maxPages);
        
        if (urls.length === 0) {
            throw new Error("No URLs found to scan.");
        }

        statusEl.innerText = `Starting scan of ${urls.length} pages...`;

        // Create Metadata
        runMetadata = {
            runId: "manual-" + Date.now(),
            startedAt: new Date().toISOString(),
            toolVersion: "standalone-1.0",
            mode: "standalone",
            config: config,
            targets: urls,
            resultsByUrl: {}
        };

        // Sequential Scan
        const MIN_DELAY = 1000;
        const safeDelay = Math.max(config.delay, MIN_DELAY);

        for (let i = 0; i < urls.length; i++) {
            const url = urls[i];
            statusEl.innerText = `Scanning ${i+1}/${urls.length}: ${url}`;
            
            try {
                if (i > 0) {
                    await new Promise(r => setTimeout(r, safeDelay));
                }

                const axeResult = await scanPage(url, config.axePath);
                
                runMetadata.resultsByUrl[url] = {
                    violations: axeResult.violations,
                    passes: axeResult.passes,
                    incomplete: axeResult.incomplete
                };

                const vCount = axeResult.violations.length;
                const div = document.createElement('div');
                div.innerHTML = `<strong>${url}</strong>: ${vCount > 0 ? `<span class="error">${vCount} violations</span>` : '<span class="success">Pass</span>'}`;
                resultsEl.appendChild(div);

            } catch (err) {
                console.error(err);
                runMetadata.resultsByUrl[url] = { error: err.message, violations: [] };
                const div = document.createElement('div');
                div.innerHTML = `<strong>${url}</strong>: <span class="error">Error: ${err.message}</span>`;
                resultsEl.appendChild(div);
            }
        }

        runMetadata.finishedAt = new Date().toISOString();
        statusEl.innerText = "Scan Complete.";
        exportBtn.disabled = false;
    }

    async function fetchSitemap(path) {
        const resp = await fetch(path);
        if (!resp.ok) throw new Error("Failed to fetch sitemap: " + resp.status);
        const text = await resp.text();
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(text, "text/xml");
        const locs = xmlDoc.getElementsByTagName("loc");
        const urls = [];
        for (let i = 0; i < locs.length; i++) {
            urls.push(locs[i].textContent);
        }
        return urls;
    }

    function scanPage(url, axePath) {
        return new Promise((resolve, reject) => {
            // Check origin
            const targetOrigin = new URL(url, window.location.origin).origin;
            if (targetOrigin !== window.location.origin) {
                reject(new Error("Skipping cross-origin URL: " + url));
                return;
            }

            // Cleanup prev
            iframe.src = 'about:blank';
            
            // Set timeout
            const timeout = setTimeout(() => {
                reject(new Error("Timeout loading page"));
            }, 15000);

            iframe.onload = () => {
                clearTimeout(timeout);
                // Inject Axe
                try {
                    const doc = iframe.contentDocument;
                    if (!doc) {
                        reject(new Error("Cannot access contentDocument (Cross-origin?)"));
                        return;
                    }

                    const script = doc.createElement('script');
                    script.src = new URL(axePath, window.location.origin).toString();
                    script.onload = () => {
                        // Run Axe
                        // @ts-ignore
                        iframe.contentWindow.axe.run(doc, (err, results) => {
                            if (err) reject(err);
                            else resolve(results);
                        });
                    };
                    script.onerror = () => reject(new Error("Failed to load axe script"));
                    doc.head.appendChild(script);

                } catch (e) {
                    reject(e);
                }
            };
            
            iframe.src = url;
        });
    }
</script>

</body>
</html>
